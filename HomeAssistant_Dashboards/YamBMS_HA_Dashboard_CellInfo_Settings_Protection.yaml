title: YAMBMS monitor
views:
  - title: BMS Summary
    path: bmss-summary
    badges: []
    cards:
      - type: markdown
        content: >-
          New tabs describing each cell status, settings, and protections
          (editable).
      - type: vertical-stack
        cards:
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: >-
                      <center> <font color="#3090C7" size="4"> BMS_01 [{{
                      states('sensor.jk_bms_1_total_runtime_formatted') }}]
                      &nbsp;&nbsp; {{
                      (states('sensor.jk_bms_1_battery_capacity_state_of_charge')
                      | float | round(0)) }} % ({{
                      (states('sensor.jk_bms_1_battery_capacity_remaining') |
                      float | round(1)) }} Ah) </font> </center>
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      {%- set online =
                      states('binary_sensor.jk_bms_1_status_online') %} {%- set
                      font_start = '<b><font size=2 color="#41CD52">' if
                      (online|bool) else '<b><font size=2 color="red">' %} {%-
                      set font_end = '</font></b>' %} {{ font_start }} BMS: {{
                      "online" if (online|bool) else "offline" }} {{ font_end }}

                      {%- set precharging =
                      states('binary_sensor.jk_bms_1_status_precharging') %} {%-
                      set font_start = '<b><font size=2 color="#41CD52">' if
                      (precharging|bool) else '<font size=2>' %} {%- set
                      font_end = '</font></b>' %} {{ font_start }}
                      <BR>Precharging: {{ "working" if (precharging|bool) else
                      "idle" }} {{ font_end }}

                      {%- set heating =
                      states('binary_sensor.jk_bms_1_status_heating') %} {%- set
                      font_start = '<b><font size=2 color="#41CD52">' if
                      (heating|bool) else '<font size=2>' %} {%- set font_end =
                      '</font></b>' %} {{ font_start }} <BR>Heating: {{
                      "working" if (heating|bool) else "idle" }} {{ font_end }}
                  - type: markdown
                    content: >-
                      {%- set charging =
                      states('binary_sensor.jk_bms_1_status_charging') %} {%-
                      set font_start = '<b><font size=2 color="#41CD52">' if
                      (charging|bool) else '<font size=2>' %} {%- set font_end =
                      '</font></b>' %} {{ font_start }} Charging: {{ "working"
                      if (charging|bool) else "idle" }} {{ font_end }}

                      {%- set discharging =
                      states('binary_sensor.jk_bms_1_status_discharging') %} {%-
                      set font_start = '<b><font size=2 color="#41CD52">' if
                      (discharging|bool) else '<font size=2>' %} {%- set
                      font_end = '</font></b>' %} {{ font_start }}
                      <BR>Discharging: {{ "working" if (discharging|bool) else
                      "idle" }} {{ font_end }}

                      {%- set balancing_direction =
                      states('sensor.jk_bms_1_balancing_direction') | int %} {%-
                      set is_working = "charging" if balancing_direction == 1
                            else "discharging" if balancing_direction == 2
                            else "idle" if balancing_direction == 0
                            else "unknown" %}
                      {%- set font_start = '<b><font size=2 color="#41CD52">' if
                      balancing_direction > 0
                            else '<b><font size=2 color="#3090C7">' if balancing_direction < 0
                            else '<font size=2>' %}
                      {%- set font_end = '</font></b>' if balancing_direction !=
                      0 else '</font>' %} {{ font_start }} <br>Balancing: {{
                      is_working }} {{ font_end }}
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: >-
                      {%- set power_draw =
                      states('sensor.jk_bms_1_battery_power') | float %} {%- set
                      power_charging =
                      states('sensor.jk_bms_1_battery_power_charging') | float
                      %} {%- set power_discharging =
                      states('sensor.jk_bms_1_battery_power_discharging') |
                      float %}

                      {%- set power_label = "(charging)" if power_charging > 0
                            else "(discharging)" if power_discharging > 0
                            else "" %}

                      {%- set power_value = power_charging if power_charging > 0
                            else power_discharging if power_discharging > 0
                            else power_draw %}

                      {%- set color = '#41CD52' if power_charging > 0
                            else '#3090C7' if power_discharging > 0
                            else '#AAAAAA' %}

                      <center> <b><font color="{{ color }}" size="6"> {{
                      power_value | round(0) }} W {{ power_label }} </font></b>
                      </center>
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      <center> <b><font color="#41CD52" size="6"> {{
                      states('sensor.jk_bms_1_battery_voltage') | float |
                      round(2) }} V </font></b><br> </center>
                  - type: markdown
                    content: >-
                      <center> <b><font color="#41CD52" size="6"> {{
                      states('sensor.jk_bms_1_battery_current') | float |
                      round(1) }} A </font></b><br> </center>
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      {%- set ovp   =
                      states('number.jk_bms_1_cell_overvoltage_protection') |
                      float | round(3) %} {%- set slv   =
                      states('number.jk_bms_1_cell_smart_sleep_voltage') | float
                      | round(3) %} {%- set rcv   =
                      states('number.jk_bms_1_cell_request_charge_voltage') |
                      float | round(3) %} {%- set bsv   =
                      states('number.jk_bms_1_cell_balancing_starting_voltage')
                      | float | round(3) %} {%- set soc100=
                      states('number.jk_bms_1_cell_soc100_voltage') | float |
                      round(3) %} {%- set ovpr  =
                      states('number.jk_bms_1_cell_overvoltage_protection_recovery')
                      | float | round(3) %} {%- set rfv   =
                      states('number.jk_bms_1_cell_request_float_voltage') |
                      float | round(3) %} {%- set uvpr  =
                      states('number.jk_bms_1_cell_undervoltage_protection_recovery')
                      | float | round(3) %} {%- set soc0  =
                      states('number.jk_bms_1_cell_soc0_voltage') | float |
                      round(3) %} {%- set uvp   =
                      states('number.jk_bms_1_cell_undervoltage_protection') |
                      float | round(3) %} {%- set poff  =
                      states('number.jk_bms_1_cell_power_off_voltage') | float |
                      round(3) %} {%- set rcvt  =
                      states('number.jk_bms_1_cell_request_charge_voltage_time')
                      %} {%- set rfvt  =
                      states('number.jk_bms_1_cell_request_float_voltage_time')
                      %} {%- set TimeOVPR =
                      states('sensor.jk_bms_1_cell_overvoltage_protection_release_time')
                      %} {%- set TimeUVPR =
                      states('sensor.jk_bms_1_cell_undervoltage_protection_release_time')
                      %}

                      {%- set rcvt = 'N/D' if rcvt == 'unknown' else (rcvt |
                      float | round(1)) %} {%- set rfvt = 'N/D' if rfvt ==
                      'unknown' else (rfvt | float | round(1)) %}

                      <table> <tr><td colspan="2"><b>VOLTAGE
                      SETTINGS</b></td></tr> <tr><td>OVP</td><td>{{ ovp }} V @
                      {{ TimeOVPR }} s</td></tr> <tr><td>Smart Sleep</td><td>{{
                      slv }} V</td></tr> <tr><td>RCV</td><td>{{ rcv }} V @ {{
                      rcvt }} h</td></tr> <tr><td>Bal.Start</td><td>{{ bsv }}
                      V</td></tr> <tr><td>SOC 100 %</td><td>{{ soc100 }}
                      V</td></tr> <tr><td>OVPR</td><td>{{ ovpr }} V</td></tr>
                      <tr><td>RFV</td><td>{{ rfv }} V @ {{ rfvt }} h</td></tr>
                      <tr><td>UVPR</td><td>{{ uvpr }} V</td></tr> <tr><td>SOC 0
                      %</td><td>{{ soc0 }} V</td></tr> <tr><td>UVP</td><td>{{
                      uvp }} V @ {{ TimeUVPR }} s</td></tr> <tr><td>Power
                      OFF</td><td>{{ poff }} V</td></tr> </table> <br>

                      <b>TEMPERATURES</b><br> MOS Temp.: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_1_temperature_powertube') | float |
                      round(1) }} °C</font><br> Battery T1: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_1_temperature_sensor_1') | float |
                      round(1) }} °C</font><br> Battery T2: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_1_temperature_sensor_2') | float |
                      round(1) }} °C</font><br> Battery T3: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_1_temperature_sensor_3') | float |
                      round(1) }} °C</font><br> Battery T4: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_1_temperature_sensor_4') | float |
                      round(1) }} °C</font><br> Battery T5: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_1_temperature_sensor_5') | float |
                      round(1) }} °C</font>
                  - type: markdown
                    content: >-
                      {%- set min_idx   =
                      states('sensor.jk_bms_1_cell_voltage_min_cell_number') |
                      int %} {%- set max_idx   =
                      states('sensor.jk_bms_1_cell_voltage_max_cell_number') |
                      int %} {%- set min_idxr  =
                      states('sensor.jk_bms_1_cell_resistance_min_cell_number')
                      | int %} {%- set max_idxr  =
                      states('sensor.jk_bms_1_cell_resistance_max_cell_number')
                      | int %} {%- set delta     =
                      states('sensor.jk_bms_1_cell_delta_voltage') | float |
                      round(4) %}

                      <table> <tr><td colspan="4"><b>CELL INFO</b>&nbsp;&nbsp;(Δ
                      = {{ delta }} V)</td></tr> {% for idx in range(1,17) %}
                        {%- set is_maxv = (idx == max_idx) %}
                        {%- set is_minv = (idx == min_idx) %}
                        {%- set is_maxr = (idx == max_idxr) %}
                        {%- set is_minr = (idx == min_idxr) %}
                        {%- set cell_v = (states('sensor.jk_bms_1_cell_voltage_%02d' % idx) | float | round(3)) %}
                        {%- set cell_r = ((states('sensor.jk_bms_1_cell_resistance_%02d' % idx) | float) * 1000) | round(2) %}
                        {%- set font_v_start = '<font color="#3090C7">' if is_maxv else '<font color="red">' if is_minv else '' %}
                        {%- set font_v_end = '</font>' if (is_maxv or is_minv) else '' %}
                        {%- set font_r_start = '<font color="#3090C7">' if is_minr else '<font color="red">' if is_maxr else '' %}
                        {%- set font_r_end = '</font>' if (is_maxr or is_minr) else '' %}
                        <tr>
                          <td>{{ "%02d" % idx }}.</td>
                          <td width="65px">{{ font_v_start }}{{ "%.3f"|format(cell_v) }} V{{ font_v_end }}</td>
                          <td width="8px" align="center">/</td>
                          <td>{{ font_r_start }}{{ "%.2f"|format(cell_r) }} mΩ{{ font_r_end }}</td>
                        </tr>
                      {% endfor %} </table>

                      <b>NET:</b> {{
                      states('sensor.jk_bms_1_network_nodes_available') }}
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: custom:stack-in-card
                margin: false
                columns: 2
                mode: horizontal
                cards:
                  - type: markdown
                    content: >-
                      <div> <b>CAPACITY</b><br> Cycle Capacity: <font
                      color="#41CD52" size="2" family="Consolas"> {{
                      states('sensor.jk_bms_1_battery_capacity_total_charging_cycle')
                      | float | round(1) }} Ah </font><br> Rem. Capacity: <font
                      color="#41CD52" size="2" family="Consolas"> {{
                      states('sensor.jk_bms_1_battery_capacity_remaining') |
                      float | round(1) }} Ah </font><br> Total Capacity: <font
                      color="#41CD52" size="2" family="Consolas"> {{
                      states('number.jk_bms_1_battery_capacity_total_setting') |
                      float | round(1) }} Ah </font> </div>
                  - type: markdown
                    content: >-
                      <div> <b>STATUS</b><br> SOC: <font color="#41CD52"
                      family="Consolas"> {{
                      states('sensor.jk_bms_1_battery_capacity_state_of_charge')
                      | float | round(0) }} % </font><br> SOH: <font
                      color="#41CD52" family="Consolas"> {{
                      states('sensor.jk_bms_1_battery_soh_valuation') | float |
                      round(0) }} % </font><br> Cycle Count: <font
                      color="#41CD52" family="Consolas"> {{
                      states('sensor.jk_bms_1_charging_cycles') | int }} cycles
                      </font><br> Balance Curr: <font color="#41CD52"
                      family="Consolas"> {{
                      states('sensor.jk_bms_1_balancing_current') | float |
                      round(3) }} A </font><br> Balancing Trig.: <font
                      color="#41CD52" family="Consolas"> {{
                      states('number.jk_bms_1_balancing_trigger_voltage') |
                      float | round(3) }} V </font> </div>
      - type: vertical-stack
        cards:
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: >-
                      <center> <font color="#3090C7" size="4"> BMS_01 [{{
                      states('sensor.jk_bms_2_total_runtime_formatted') }}]
                      &nbsp;&nbsp; {{
                      (states('sensor.jk_bms_2_battery_capacity_state_of_charge')
                      | float | round(0)) }} % ({{
                      (states('sensor.jk_bms_2_battery_capacity_remaining') |
                      float | round(1)) }} Ah) </font> </center>
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      {%- set online =
                      states('binary_sensor.jk_bms_2_status_online') %} {%- set
                      font_start = '<b><font size=2 color="#41CD52">' if
                      (online|bool) else '<b><font size=2 color="red">' %} {%-
                      set font_end = '</font></b>' %} {{ font_start }} BMS: {{
                      "online" if (online|bool) else "offline" }} {{ font_end }}

                      {%- set precharging =
                      states('binary_sensor.jk_bms_2_status_precharging') %} {%-
                      set font_start = '<b><font size=2 color="#41CD52">' if
                      (precharging|bool) else '<font size=2>' %} {%- set
                      font_end = '</font></b>' %} {{ font_start }}
                      <BR>Precharging: {{ "working" if (precharging|bool) else
                      "idle" }} {{ font_end }}

                      {%- set heating =
                      states('binary_sensor.jk_bms_2_status_heating') %} {%- set
                      font_start = '<b><font size=2 color="#41CD52">' if
                      (heating|bool) else '<font size=2>' %} {%- set font_end =
                      '</font></b>' %} {{ font_start }} <BR>Heating: {{
                      "working" if (heating|bool) else "idle" }} {{ font_end }}
                  - type: markdown
                    content: >-
                      {%- set charging =
                      states('binary_sensor.jk_bms_2_status_charging') %} {%-
                      set font_start = '<b><font size=2 color="#41CD52">' if
                      (charging|bool) else '<font size=2>' %} {%- set font_end =
                      '</font></b>' %} {{ font_start }} Charging: {{ "working"
                      if (charging|bool) else "idle" }} {{ font_end }}

                      {%- set discharging =
                      states('binary_sensor.jk_bms_2_status_discharging') %} {%-
                      set font_start = '<b><font size=2 color="#41CD52">' if
                      (discharging|bool) else '<font size=2>' %} {%- set
                      font_end = '</font></b>' %} {{ font_start }}
                      <BR>Discharging: {{ "working" if (discharging|bool) else
                      "idle" }} {{ font_end }}

                      {%- set balancing_direction =
                      states('sensor.jk_bms_2_balancing_direction') | int %} {%-
                      set is_working = "charging" if balancing_direction == 1
                            else "discharging" if balancing_direction == 2
                            else "idle" if balancing_direction == 0
                            else "unknown" %}
                      {%- set font_start = '<b><font size=2 color="#41CD52">' if
                      balancing_direction > 0
                            else '<b><font size=2 color="#3090C7">' if balancing_direction < 0
                            else '<font size=2>' %}
                      {%- set font_end = '</font></b>' if balancing_direction !=
                      0 else '</font>' %} {{ font_start }} <br>Balancing: {{
                      is_working }} {{ font_end }}
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: >-
                      {%- set power_draw =
                      states('sensor.jk_bms_2_battery_power') | float %} {%- set
                      power_charging =
                      states('sensor.jk_bms_2_battery_power_charging') | float
                      %} {%- set power_discharging =
                      states('sensor.jk_bms_2_battery_power_discharging') |
                      float %}

                      {%- set power_label = "(charging)" if power_charging > 0
                            else "(discharging)" if power_discharging > 0
                            else "" %}

                      {%- set power_value = power_charging if power_charging > 0
                            else power_discharging if power_discharging > 0
                            else power_draw %}

                      {%- set color = '#41CD52' if power_charging > 0
                            else '#3090C7' if power_discharging > 0
                            else '#AAAAAA' %}

                      <center> <b><font color="{{ color }}" size="6"> {{
                      power_value | round(0) }} W {{ power_label }} </font></b>
                      </center>
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      <center> <b><font color="#41CD52" size="6"> {{
                      states('sensor.jk_bms_2_battery_voltage') | float |
                      round(2) }} V </font></b><br> </center>
                  - type: markdown
                    content: >-
                      <center> <b><font color="#41CD52" size="6"> {{
                      states('sensor.jk_bms_2_battery_current') | float |
                      round(1) }} A </font></b><br> </center>
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      {%- set ovp   =
                      states('number.jk_bms_2_cell_overvoltage_protection') |
                      float | round(3) %} {%- set slv   =
                      states('number.jk_bms_2_cell_smart_sleep_voltage') | float
                      | round(3) %} {%- set rcv   =
                      states('number.jk_bms_2_cell_request_charge_voltage') |
                      float | round(3) %} {%- set bsv   =
                      states('number.jk_bms_2_cell_balancing_starting_voltage')
                      | float | round(3) %} {%- set soc100=
                      states('number.jk_bms_2_cell_soc100_voltage') | float |
                      round(3) %} {%- set ovpr  =
                      states('number.jk_bms_2_cell_overvoltage_protection_recovery')
                      | float | round(3) %} {%- set rfv   =
                      states('number.jk_bms_2_cell_request_float_voltage') |
                      float | round(3) %} {%- set uvpr  =
                      states('number.jk_bms_2_cell_undervoltage_protection_recovery')
                      | float | round(3) %} {%- set soc0  =
                      states('number.jk_bms_2_cell_soc0_voltage') | float |
                      round(3) %} {%- set uvp   =
                      states('number.jk_bms_2_cell_undervoltage_protection') |
                      float | round(3) %} {%- set poff  =
                      states('number.jk_bms_2_cell_power_off_voltage') | float |
                      round(3) %} {%- set rcvt  =
                      states('number.jk_bms_2_cell_request_charge_voltage_time')
                      %} {%- set rfvt  =
                      states('number.jk_bms_2_cell_request_float_voltage_time')
                      %} {%- set TimeOVPR =
                      states('sensor.jk_bms_2_cell_overvoltage_protection_release_time')
                      %} {%- set TimeUVPR =
                      states('sensor.jk_bms_2_cell_undervoltage_protection_release_time')
                      %}

                      {%- set rcvt = 'N/D' if rcvt == 'unknown' else (rcvt |
                      float | round(1)) %} {%- set rfvt = 'N/D' if rfvt ==
                      'unknown' else (rfvt | float | round(1)) %}

                      <table> <tr><td colspan="2"><b>VOLTAGE
                      SETTINGS</b></td></tr> <tr><td>OVP</td><td>{{ ovp }} V @
                      {{ TimeOVPR }} s</td></tr> <tr><td>Smart Sleep</td><td>{{
                      slv }} V</td></tr> <tr><td>RCV</td><td>{{ rcv }} V @ {{
                      rcvt }} h</td></tr> <tr><td>Bal.Start</td><td>{{ bsv }}
                      V</td></tr> <tr><td>SOC 100 %</td><td>{{ soc100 }}
                      V</td></tr> <tr><td>OVPR</td><td>{{ ovpr }} V</td></tr>
                      <tr><td>RFV</td><td>{{ rfv }} V @ {{ rfvt }} h</td></tr>
                      <tr><td>UVPR</td><td>{{ uvpr }} V</td></tr> <tr><td>SOC 0
                      %</td><td>{{ soc0 }} V</td></tr> <tr><td>UVP</td><td>{{
                      uvp }} V @ {{ TimeUVPR }} s</td></tr> <tr><td>Power
                      OFF</td><td>{{ poff }} V</td></tr> </table> <br>

                      <b>TEMPERATURES</b><br> MOS Temp.: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_2_temperature_powertube') | float |
                      round(1) }} °C</font><br> Battery T1: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_2_temperature_sensor_1') | float |
                      round(1) }} °C</font><br> Battery T2: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_2_temperature_sensor_2') | float |
                      round(1) }} °C</font><br> Battery T3: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_2_temperature_sensor_3') | float |
                      round(1) }} °C</font><br> Battery T4: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_2_temperature_sensor_4') | float |
                      round(1) }} °C</font><br> Battery T5: <font
                      color="#41CD52">{{
                      states('sensor.jk_bms_2_temperature_sensor_5') | float |
                      round(1) }} °C</font>
                  - type: markdown
                    content: >-
                      {%- set min_idx   =
                      states('sensor.jk_bms_2_cell_voltage_min_cell_number') |
                      int %} {%- set max_idx   =
                      states('sensor.jk_bms_2_cell_voltage_max_cell_number') |
                      int %} {%- set min_idxr  =
                      states('sensor.jk_bms_2_cell_resistance_min_cell_number')
                      | int %} {%- set max_idxr  =
                      states('sensor.jk_bms_2_cell_resistance_max_cell_number')
                      | int %} {%- set delta     =
                      states('sensor.jk_bms_2_cell_delta_voltage') | float |
                      round(4) %}

                      <table> <tr><td colspan="4"><b>CELL INFO</b>&nbsp;&nbsp;(Δ
                      = {{ delta }} V)</td></tr> {% for idx in range(1,17) %}
                        {%- set is_maxv = (idx == max_idx) %}
                        {%- set is_minv = (idx == min_idx) %}
                        {%- set is_maxr = (idx == max_idxr) %}
                        {%- set is_minr = (idx == min_idxr) %}
                        {%- set cell_v = (states('sensor.jk_bms_2_cell_voltage_%02d' % idx) | float | round(3)) %}
                        {%- set cell_r = ((states('sensor.jk_bms_2_cell_resistance_%02d' % idx) | float) * 1000) | round(2) %}
                        {%- set font_v_start = '<font color="#3090C7">' if is_maxv else '<font color="red">' if is_minv else '' %}
                        {%- set font_v_end = '</font>' if (is_maxv or is_minv) else '' %}
                        {%- set font_r_start = '<font color="#3090C7">' if is_minr else '<font color="red">' if is_maxr else '' %}
                        {%- set font_r_end = '</font>' if (is_maxr or is_minr) else '' %}
                        <tr>
                          <td>{{ "%02d" % idx }}.</td>
                          <td width="65px">{{ font_v_start }}{{ "%.3f"|format(cell_v) }} V{{ font_v_end }}</td>
                          <td width="8px" align="center">/</td>
                          <td>{{ font_r_start }}{{ "%.2f"|format(cell_r) }} mΩ{{ font_r_end }}</td>
                        </tr>
                      {% endfor %} </table>

                      <b>NET:</b> {{
                      states('sensor.jk_bms_2_network_nodes_available') }}
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: custom:stack-in-card
                margin: false
                columns: 2
                mode: horizontal
                cards:
                  - type: markdown
                    content: >-
                      <div> <b>CAPACITY</b><br> Cycle Capacity: <font
                      color="#41CD52" size="2" family="Consolas"> {{
                      states('sensor.jk_bms_2_battery_capacity_total_charging_cycle')
                      | float | round(1) }} Ah </font><br> Rem. Capacity: <font
                      color="#41CD52" size="2" family="Consolas"> {{
                      states('sensor.jk_bms_2_battery_capacity_remaining') |
                      float | round(1) }} Ah </font><br> Total Capacity: <font
                      color="#41CD52" size="2" family="Consolas"> {{
                      states('number.jk_bms_2_battery_capacity_total_setting') |
                      float | round(1) }} Ah </font> </div>
                  - type: markdown
                    content: >-
                      <div> <b>STATUS</b><br> SOC: <font color="#41CD52"
                      family="Consolas"> {{
                      states('sensor.jk_bms_2_battery_capacity_state_of_charge')
                      | float | round(0) }} % </font><br> SOH: <font
                      color="#41CD52" family="Consolas"> {{
                      states('sensor.jk_bms_2_battery_soh_valuation') | float |
                      round(0) }} % </font><br> Cycle Count: <font
                      color="#41CD52" family="Consolas"> {{
                      states('sensor.jk_bms_2_charging_cycles') | int }} cycles
                      </font><br> Balance Curr: <font color="#41CD52"
                      family="Consolas"> {{
                      states('sensor.jk_bms_2_balancing_current') | float |
                      round(3) }} A </font><br> Balancing Trig.: <font
                      color="#41CD52" family="Consolas"> {{
                      states('number.jk_bms_2_balancing_trigger_voltage') |
                      float | round(3) }} V </font> </div>
  - title: BMS1 (cells)
    cards:
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_01
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_05
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_02
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_06
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_03
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_07
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_04
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_08
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_09
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_10
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_11
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_12
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_13
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_14
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_15
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_1_cell_voltage_16
      - graph: line
        type: sensor
        detail: 1
        entity: sensor.jk_bms_1_cell_voltage_max_cell_number
      - graph: line
        type: sensor
        detail: 1
        entity: sensor.jk_bms_1_cell_voltage_min_cell_number
  - title: BMS2(cells)
    cards:
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_01
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_05
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_02
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_06
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_03
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_07
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_04
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_08
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_09
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_10
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_11
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_12
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_13
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_14
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_15
      - type: gauge
        needle: true
        max: 3.65
        min: 3
        segments:
          - from: 2
            color: '#db4437'
          - from: 2.4
            color: '#ffa600'
          - from: 3.1
            color: '#43a047'
          - from: 3.35
            color: '#999999'
          - from: 3.45
            color: '#00a6ee'
          - from: 3.6
            color: '#ffa600'
          - from: 3.65
            color: '#db4437'
        entity: sensor.jk_bms_2_cell_voltage_16
      - graph: line
        type: sensor
        detail: 1
        entity: sensor.jk_bms_2_cell_voltage_max_cell_number
      - graph: line
        type: sensor
        detail: 1
        entity: sensor.jk_bms_2_cell_voltage_min_cell_number
  - path: bms0_settings
    title: BMS1 (SETTINGS)
    icon: ''
    cards:
      - type: custom:stack-in-card
        keep:
          margin: false
          box_shadow: false
          background: false
        cards:
          - type: grid
            square: false
            columns: 2
            cards:
              - type: markdown
                content: >-
                  {%- set vid = states('sensor.jk_bms_1_info_vendorid') %} {%-
                  set swv = states('sensor.jk_bms_1_info_software_version') %}
                  {%- set hwv = states('sensor.jk_bms_1_info_hardware_version')
                  %} {%- set dna = states('sensor.jk_bms_1_info_device_name') %}
                  {%- set dsn =
                  states('sensor.jk_bms_1_info_device_serial_number')
                  %}               {%- set pin =
                  states('sensor.jk_bms_1_info_device_password') %}  {%- set
                  settings_pin =
                  states('sensor.jk_bms_1_info_device_setup_passcode') %} {%-
                  set uart1 = states('sensor.jk_bms_1_uart1_protocol_number')
                  %}  {%- set uart2 =
                  states('sensor.jk_bms_1_uart2_protocol_number') %} {%- set
                  cell_number_settings =
                  states('sensor.jk_bms_1_cell_count_settings') %} {%- set
                  cell_number_real = states('sensor.jk_bms_1_cell_count_real')
                  %} <table> <tr><td colspan=2><b>BMS INFO:</b></td></tr>
                  <tr><td>VendorID:</td><td>{{vid}}</tr> <tr><td>HARD
                  ver:</td><td>{{swv}}</tr> <tr><td>SOFT
                  ver:</td><td>{{hwv}}</tr>           <tr><td>DEV
                  name:</td><td>{{dna}}</tr>  <tr><td>DEV
                  S/N</td><td>{{dsn}}</tr>               <tr><td>BT
                  PASS:</td><td>{{pin}}</tr><tr><td>
                  PASS:</td><td>{{settings_pin}}</tr>
                  <tr><td>UART1:</td><td>{{uart1}}</tr>   
                  <tr><td>UART2:</td><td>{{uart2}}</tr>            <tr><td>Cells
                  (sett.):</td><td>{{cell_number_settings}}</tr>                         
                  <tr><td>Cells
                  (real):</td><td>{{cell_number_real}}</tr>                                       
                  </table><br>
              - type: markdown
                content: >-
                  {%- set min_idx =
                  states('sensor.jk_bms_1_cell_voltage_min_cell_number') %} 

                  {%- set max_idx =
                  states('sensor.jk_bms_1_cell_voltage_max_cell_number') %}  

                  {%- set delta =
                  (states('sensor.jk_bms_1_cell_delta_voltage')|float) %}  

                  <table> <tr><td colspan=4><b>NETWORK
                  DEVICES:</b>&nbsp;&nbsp;</td></tr> <tr><td>{%- set
                  network_nodes_available =
                  states('sensor.jk_bms_1_network_nodes_available') %} 
                  </td></tr></table>

                  {{network_nodes_available}}</b>&nbsp;&nbsp;
      - type: entities
        entities:
          - entity: switch.jk_bms_1_charging
            name: CHARGE
          - entity: switch.jk_bms_1_discharging
            name: DISCHARGE
          - entity: switch.jk_bms_1_balancing
            name: BALANCING
          - entity: switch.jk_bms_1_emergency
            name: EMERGENCY
          - entity: switch.jk_bms_1_heating
            name: HEATING
          - entity: switch.jk_bms_1_disable_temperature_sensors
            name: DISABLE TEMPERATURE SENSORS
          - entity: switch.jk_bms_1_display_always_on
            name: DISPLAY ALWAYS ON
          - entity: switch.jk_bms_1_smart_sleep_on
            name: SMART SLEEP ON
          - entity: switch.jk_bms_1_disable_pcl_module
            name: DISABLE PCL MODULE
          - entity: switch.jk_bms_1_timed_stored_data
            name: TIMED_STORED_DATA
          - entity: switch.jk_bms_1_charging_float_mode
            name: CHARGE FLOAT MODE
        title: Switch (Read Only)
        show_header_toggle: false
      - type: vertical-stack
        cards:
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: |-
                      <center>
                        {%- set alarm_active = states('sensor.jk_bms_1_battery_total_alarms_active')|int %}
                        {%- set alarm_active = 0 %}                
                        {%- set alarm_count = states('sensor.jk_bms_1_battery_total_alarms_count')|int %}
                        {%- set alarm_label = '<font size=4>ALARMS BMS_00</font>' if alarm_active==0
                            else '<b><font size=5 color=red>ALARMS BMS_00</font></b>' %}
                        {{alarm_label}} ({{ alarm_active }}/{{ alarm_count -}})<br></center>
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: >-
                      {%- set alarm_active =
                      states('sensor.jk_bms_1_battery_total_alarms_active')|int
                      %}

                      {%- set alarm_count =
                      states('sensor.jk_bms_1_battery_total_alarms_count')|int
                      %}

                      {%- set alarm_active = 0 %} 

                      {%- set alarms_label = '<center>No alarms found. Working
                      well</center>' if (alarm_active==0)
                          else 'ALARMS FOUND:' %} 
                      {{ alarms_label }}    

                      <center>  {% for state in states -%} 
                        {% if state.entity_id.startswith('binary_sensor.jk_bms_1_alarm_') and state.state!="off" %}
                          {% set last_word = state.name.split()[-1] | string %}
                          {% set last_status = state.state %}
                          {%- set font_start = '<font color="#3090C7">' if last_status=="off"
                              else '<font color="red">' if last_status=="on"  
                              else '<font color="gray">' %} 
                          {%- set font_end = '</font>' if last_status 
                              else '' %} 
                         {{ font_start }} {{ last_word }} (status: {{last_status}}) {{ font_end -}}<br>
                        {% endif %}
                      {% endfor %} </center>
          - type: grid
            square: false
            columns: 1
            cards:
              - type: markdown
                content: |-
                  <center>
                    {%- set alarm_active = states('sensor.jk_bms_2_battery_total_alarms_active')|int %}
                    {%- set alarm_active = 0 %}                
                    {%- set alarm_count = states('sensor.jk_bms_2_battery_total_alarms_count')|int %}
                    {%- set alarm_label = '<font size=4>ALARMS BMS_01</font>' if alarm_active==0
                        else '<b><font size=5 color=red>ALARMS BMS_01</font></b>' %}
                    {{alarm_label}} ({{ alarm_active }}/{{ alarm_count -}})<br></center>
          - type: grid
            square: false
            columns: 1
            cards:
              - type: markdown
                content: >-
                  {%- set alarm_active =
                  states('sensor.jk_bms_2_battery_total_alarms_active')|int %}

                  {%- set alarm_count =
                  states('sensor.jk_bms_2_battery_total_alarms_count')|int %}

                  {%- set alarm_active = 0 %} 

                  {%- set alarms_label = '<center>No alarms found. Working
                  well</center>' if (alarm_active==0)
                      else 'ALARMS FOUND:' %} 
                  {{ alarms_label }}    

                  <center>  {% for state in states -%} 
                    {% if state.entity_id.startswith('binary_sensor.jk_bms_2_alarm_') and state.state!="off" %}
                      {% set last_word = state.name.split()[-1] | string %}
                      {% set last_status = state.state %}
                      {%- set font_start = '<font color="#3090C7">' if last_status=="off"
                          else '<font color="red">' if last_status=="on"  
                          else '<font color="gray">' %} 
                      {%- set font_end = '</font>' if last_status 
                          else '' %} 
                     {{ font_start }} {{ last_word }} (status: {{last_status}}) {{ font_end -}}<br>
                    {% endif %}
                  {% endfor %} </center>
      - type: entities
        entities:
          - sensor.jk_bms_1_battery_total_alarms_active
          - sensor.jk_bms_1_battery_total_alarms_count
          - sensor.jk_bms_2_battery_total_alarms_active
          - sensor.jk_bms_2_battery_total_alarms_count
      - square: true
        type: grid
        cards:
          - type: tile
            entity: binary_sensor.jk_bms_1_alarm_batovp
          - type: tile
            entity: binary_sensor.jk_bms_1_alarm_batuvp
          - type: tile
            entity: binary_sensor.jk_bms_1_alarm_chocp
        columns: 3
  - path: bms1_settings
    title: BMS2 (SETTINGS)
    icon: ''
    cards:
      - type: vertical-stack
        cards:
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 2
                cards:
                  - type: markdown
                    content: >-
                      {%- set vid = states('sensor.jk_bms_2_info_vendorid') %}
                      {%- set swv =
                      states('sensor.jk_bms_2_info_software_version') %} {%- set
                      hwv = states('sensor.jk_bms_2_info_hardware_version') %}
                      {%- set dna = states('sensor.jk_bms_2_info_device_name')
                      %} {%- set dsn =
                      states('sensor.jk_bms_2_info_device_serial_number')
                      %}               {%- set pin =
                      states('sensor.jk_bms_2_info_device_password') %}  {%- set
                      settings_pin =
                      states('sensor.jk_bms_2_info_device_setup_passcode') %}
                      {%- set uart1 =
                      states('sensor.jk_bms_2_uart1_protocol_number') %}  {%-
                      set uart2 =
                      states('sensor.jk_bms_2_uart2_protocol_number') %} {%- set
                      cell_number_settings =
                      states('sensor.jk_bms_2_cell_count_settings') %} {%- set
                      cell_number_real =
                      states('sensor.jk_bms_2_cell_count_real') %} <table>
                      <tr><td colspan=2><b>BMS INFO:</b></td></tr>
                      <tr><td>VendorID:</td><td>{{vid}}</tr> <tr><td>HARD
                      ver:</td><td>{{swv}}</tr> <tr><td>SOFT
                      ver:</td><td>{{hwv}}</tr>           <tr><td>DEV
                      name:</td><td>{{dna}}</tr>  <tr><td>DEV
                      S/N</td><td>{{dsn}}</tr>               <tr><td>BT
                      PASS:</td><td>{{pin}}</tr><tr><td>
                      PASS:</td><td>{{settings_pin}}</tr>
                      <tr><td>UART1:</td><td>{{uart1}}</tr>   
                      <tr><td>UART2:</td><td>{{uart2}}</tr>           
                      <tr><td>Cells
                      (sett.):</td><td>{{cell_number_settings}}</tr>                         
                      <tr><td>Cells
                      (real):</td><td>{{cell_number_real}}</tr>                                       
                      </table><br>
                  - type: markdown
                    content: >-
                      {%- set min_idx =
                      states('sensor.jk_bms_2_cell_voltage_min_cell_number') %} 

                      {%- set max_idx =
                      states('sensor.jk_bms_2_cell_voltage_max_cell_number')
                      %}  

                      {%- set delta =
                      (states('sensor.jk_bms_2_cell_delta_voltage')|float) %}  

                      <table> <tr><td colspan=4><b>NETWORK
                      DEVICES:</b>&nbsp;&nbsp;</td></tr> <tr><td>{%- set
                      network_nodes_available =
                      states('sensor.jk_bms_2_network_nodes_available') %} 
                      </td></tr></table>

                      {{network_nodes_available}}</b>&nbsp;&nbsp;
      - type: entities
        entities:
          - entity: switch.jk_bms_2_charging
            name: CHARGE
          - entity: switch.jk_bms_2_discharging
            name: DISCHARGE
          - entity: switch.jk_bms_2_balancing
            name: BALANCING
          - entity: switch.jk_bms_2_emergency
            name: EMERGENCY
          - entity: switch.jk_bms_2_heating
            name: HEATING
          - entity: switch.jk_bms_2_disable_temperature_sensors
            name: DISABLE TEMPERATURE SENSORS
          - entity: switch.jk_bms_2_display_always_on
            name: DISPLAY ALWAYS ON
          - entity: switch.jk_bms_2_smart_sleep_on
            name: SMART SLEEP ON
          - entity: switch.jk_bms_2_disable_pcl_module
            name: DISABLE PCL MODULE
          - entity: switch.jk_bms_2_timed_stored_data
            name: TIMED_STORED_DATA
          - entity: switch.jk_bms_2_charging_float_mode
            name: CHARGE FLOAT MODE
        title: Switch (Read Only)
        show_header_toggle: false
      - type: vertical-stack
        cards:
          - type: custom:stack-in-card
            keep:
              margin: false
              box_shadow: false
              background: false
            cards:
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: |-
                      <center>
                        {%- set alarm_active = states('sensor.jk_bms_1_battery_total_alarms_active')|int %}
                        {%- set alarm_active = 0 %}                
                        {%- set alarm_count = states('sensor.jk_bms_1_battery_total_alarms_count')|int %}
                        {%- set alarm_label = '<font size=4>ALARMS BMS_00</font>' if alarm_active==0
                            else '<b><font size=5 color=red>ALARMS BMS_00</font></b>' %}
                        {{alarm_label}} ({{ alarm_active }}/{{ alarm_count -}})<br></center>
              - type: grid
                square: false
                columns: 1
                cards:
                  - type: markdown
                    content: >-
                      {%- set alarm_active =
                      states('sensor.jk_bms_1_battery_total_alarms_active')|int
                      %}

                      {%- set alarm_count =
                      states('sensor.jk_bms_1_battery_total_alarms_count')|int
                      %}

                      {%- set alarm_active = 0 %} 

                      {%- set alarms_label = '<center>No alarms found. Working
                      well</center>' if (alarm_active==0)
                          else 'ALARMS FOUND:' %} 
                      {{ alarms_label }}    

                      <center>  {% for state in states -%} 
                        {% if state.entity_id.startswith('binary_sensor.jk_bms_1_alarm_') and state.state!="off" %}
                          {% set last_word = state.name.split()[-1] | string %}
                          {% set last_status = state.state %}
                          {%- set font_start = '<font color="#3090C7">' if last_status=="off"
                              else '<font color="red">' if last_status=="on"  
                              else '<font color="gray">' %} 
                          {%- set font_end = '</font>' if last_status 
                              else '' %} 
                         {{ font_start }} {{ last_word }} (status: {{last_status}}) {{ font_end -}}<br>
                        {% endif %}
                      {% endfor %} </center>
          - type: grid
            square: false
            columns: 1
            cards:
              - type: markdown
                content: |-
                  <center>
                    {%- set alarm_active = states('sensor.jk_bms_2_battery_total_alarms_active')|int %}
                    {%- set alarm_active = 0 %}                
                    {%- set alarm_count = states('sensor.jk_bms_2_battery_total_alarms_count')|int %}
                    {%- set alarm_label = '<font size=4>ALARMS BMS_01</font>' if alarm_active==0
                        else '<b><font size=5 color=red>ALARMS BMS_01</font></b>' %}
                    {{alarm_label}} ({{ alarm_active }}/{{ alarm_count -}})<br></center>
          - type: grid
            square: false
            columns: 1
            cards:
              - type: markdown
                content: >-
                  {%- set alarm_active =
                  states('sensor.jk_bms_2_battery_total_alarms_active')|int %}

                  {%- set alarm_count =
                  states('sensor.jk_bms_2_battery_total_alarms_count')|int %}

                  {%- set alarm_active = 0 %} 

                  {%- set alarms_label = '<center>No alarms found. Working
                  well</center>' if (alarm_active==0)
                      else 'ALARMS FOUND:' %} 
                  {{ alarms_label }}    

                  <center>  {% for state in states -%} 
                    {% if state.entity_id.startswith('binary_sensor.jk_bms_2_alarm_') and state.state!="off" %}
                      {% set last_word = state.name.split()[-1] | string %}
                      {% set last_status = state.state %}
                      {%- set font_start = '<font color="#3090C7">' if last_status=="off"
                          else '<font color="red">' if last_status=="on"  
                          else '<font color="gray">' %} 
                      {%- set font_end = '</font>' if last_status 
                          else '' %} 
                     {{ font_start }} {{ last_word }} (status: {{last_status}}) {{ font_end -}}<br>
                    {% endif %}
                  {% endfor %} </center>
  - title: BMS1 (PROTECTION)
    path: protection_bms1
    cards:
      - type: entities
        entities:
          - entity: number.jk_bms_1_mos_overtemperature_protection
            name: MOS overT
          - entity: number.jk_bms_1_mos_overtemperature_protection_recovery
            name: MOS overT recovery
          - entity: number.jk_bms_1_charging_overtemperature_protection
            name: charging overT
          - entity: number.jk_bms_1_discharging_overtemperature_protection
            name: discharging overT
          - entity: number.jk_bms_1_charging_overtemperature_protection_recovery
            name: charging overT recovery
          - entity: number.jk_bms_1_discharging_overtemperature_protection_recovery
            name: discharging overT recovery
          - entity: number.jk_bms_1_charging_lowtemperature_protection_recovery
            name: charging lowT recovery
          - entity: number.jk_bms_1_charging_lowtemperature_protection
            name: charging lowT
        title: TEMPERATURE
      - type: entities
        entities:
          - entity: number.jk_bms_1_max_charging_current
            name: MAX current
          - entity: number.jk_bms_1_charging_overcurrent_protection_delay
            name: Over current delay
          - entity: number.jk_bms_1_charging_overcurrent_protection_recovery_delay
            name: Over current recovery delay
          - entity: sensor.jk_bms_1_charging_overcurrent_protection_release_time
            name: Over current release time
          - entity: sensor.jk_bms_1_charging_short_circuit_protection_release_time
            name: ShortCircuit release time
          - entity: number.jk_bms_1_precharging_time_from_discharge
            name: Precharging time from discharging
          - entity: number.jk_bms_1_cell_request_charge_voltage_time
            name: Absortion Time
          - entity: number.jk_bms_1_cell_request_float_voltage_time
            name: Float Time
        title: CHARGING protection
      - type: entities
        entities:
          - entity: number.jk_bms_1_max_discharging_current
            name: MAX current
          - entity: number.jk_bms_1_discharging_overcurrent_protection_delay
            name: Over current delay
          - entity: number.jk_bms_1_discharging_overcurrent_protection_recovery_delay
            name: Over current recovery delay
          - entity: sensor.jk_bms_1_discharging_overcurrent_protection_release_time
            name: Over current release time
          - entity: sensor.jk_bms_1_discharging_short_circuit_protection_release_time
            name: ShortCircuit release time
        title: DISCHARGING PROTECTION
      - type: entities
        entities:
          - entity: number.jk_bms_1_short_circuit_protection_delay
            name: Delay
          - entity: number.jk_bms_1_short_circuit_protection_recovery_delay
            name: Recovery delay
        title: SHORT CIRCUIT PROTECTION
      - type: entities
        entities:
          - entity: number.jk_bms_1_max_balancing_current
            name: MAX current
        title: BALANCING PROTECTION
  - title: BMS2 (PROTECTION)
    path: protection_bms2
    cards:
      - type: entities
        entities:
          - entity: number.jk_bms_2_mos_overtemperature_protection
            name: MOS overT
          - entity: number.jk_bms_2_mos_overtemperature_protection_recovery
            name: MOS overT recovery
          - entity: number.jk_bms_2_charging_overtemperature_protection
            name: charging overT
          - entity: number.jk_bms_2_discharging_overtemperature_protection
            name: discharging overT
          - entity: number.jk_bms_2_charging_overtemperature_protection_recovery
            name: charging overT recovery
          - entity: number.jk_bms_2_discharging_overtemperature_protection_recovery
            name: discharging overT recovery
          - entity: number.jk_bms_2_charging_lowtemperature_protection_recovery
            name: charging lowT recovery
          - entity: number.jk_bms_2_charging_lowtemperature_protection
            name: charging lowT
        title: TEMPERATURE
      - type: entities
        entities:
          - entity: number.jk_bms_2_max_charging_current
            name: MAX current
          - entity: number.jk_bms_2_charging_overcurrent_protection_delay
            name: Over current delay
          - entity: number.jk_bms_2_charging_overcurrent_protection_recovery_delay
            name: Over current recovery delay
          - entity: sensor.jk_bms_2_charging_overcurrent_protection_release_time
            name: Over current release time
          - entity: sensor.jk_bms_2_charging_short_circuit_protection_release_time
            name: ShortCircuit release time
          - entity: number.jk_bms_2_precharging_time_from_discharge
            name: Precharging time from discharging
          - entity: number.jk_bms_2_cell_request_charge_voltage_time
            name: Absortion Time
          - entity: number.jk_bms_2_cell_request_float_voltage_time
            name: Float Time
        title: CHARGING protection
      - type: entities
        entities:
          - entity: number.jk_bms_2_max_discharging_current
            name: MAX current
          - entity: number.jk_bms_2_discharging_overcurrent_protection_delay
            name: Over current delay
          - entity: number.jk_bms_2_discharging_overcurrent_protection_recovery_delay
            name: Over current recovery delay
          - entity: sensor.jk_bms_2_discharging_overcurrent_protection_release_time
            name: Over current release time
          - entity: sensor.jk_bms_2_discharging_short_circuit_protection_release_time
            name: ShortCircuit release time
        title: DISCHARGING PROTECTION
      - type: entities
        entities:
          - entity: number.jk_bms_2_short_circuit_protection_delay
            name: Delay
          - entity: number.jk_bms_2_short_circuit_protection_recovery_delay
            name: Recovery delay
        title: SHORT CIRCUIT PROTECTION
      - type: entities
        entities:
          - entity: number.jk_bms_2_max_balancing_current
            name: MAX current
        title: BALANCING PROTECTION
